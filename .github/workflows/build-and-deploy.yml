name: "Build and Release Godot-QuickStart"

# Trigger on version tags and manual dispatch
on:
  push:
    tags:
      - "v*" # Push events to matching v*, i.e. v1.0, v20.15.10

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  GODOT_VERSION: "4.4.1"
  GODOT_EXPORT_VERSION: "4.4-stable"
  GAME_NAME: "Godot-QuickStart"

jobs:
  # Validation job - runs first to catch issues early
  validate:
    runs-on: ubuntu-latest
    name: "üîç Validate Project"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false

      - name: Verify project structure
        run: |
          echo "üîç Checking project structure..."

          if [ ! -f "project.godot" ]; then
            echo "‚ùå project.godot not found!"
            exit 1
          fi

          if [ ! -d "scenes" ]; then
            echo "‚ùå scenes directory not found!"
            exit 1
          fi

          if [ ! -d "scripts" ]; then
            echo "‚ùå scripts directory not found!"
            exit 1
          fi

          echo "‚úÖ Project structure is valid"

      - name: Import and validate project
        run: |
          echo "üì¶ Importing project..."
          timeout 120 godot --headless --verbose --editor --quit-after 5 --path . || echo "‚ö†Ô∏è Import completed"

          echo "üîç Validating GDScript files..."
          find . -name "*.gd" -not -path "./.godot/*" | while read -r script; do
            echo "Checking $script..."
            godot --headless --check-only --script "$script" --path . || exit 1
          done

          echo "‚úÖ Validation completed"

  # Build job - runs after validation
  build_game:
    runs-on: ubuntu-latest
    name: "üèóÔ∏è Build Game"
    needs: validate
    steps:
      # Always include the checkout step so that
      # your project is available for Godot to export
    - name: Checkout
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Install Wine
      id: wine_install
      run: |
        sudo apt-get update
        sudo apt-get install -y wine64
        echo "WINE_PATH=$(which wine64)" >> $GITHUB_OUTPUT

    - name: Export Game
      id: export
      # Use latest version (see releases for all versions)
      uses: firebelley/godot-export@v6.0.0
      with:
        # Defining all the required inputs
        godot_executable_download_url: https://github.com/godotengine/godot/releases/download/${{ env.GODOT_EXPORT_VERSION }}/Godot_v${{ env.GODOT_EXPORT_VERSION }}_linux.x86_64.zip
        godot_export_templates_download_url: https://github.com/godotengine/godot/releases/download/${{ env.GODOT_EXPORT_VERSION }}/Godot_v${{ env.GODOT_EXPORT_VERSION }}_export_templates.tpz
        relative_project_path: ./ # Project is in root directory
        cache: true
        export_debug: false
        archive_output: true
        wine_path: ${{ steps.wine_install.outputs.WINE_PATH }}

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.GAME_NAME }}-builds-${{ github.sha }}
        path: ${{ steps.export.outputs.archive_directory }}/*
        retention-days: 30

  # Release job - only runs on version tags
  release_game:
    # Only run this job if it's a version tag push
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build_game # Wait for build to complete
    runs-on: ubuntu-latest
    permissions:
      contents: write # Need permissions for release creation
    name: "üì¶ Create Release"
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.GAME_NAME }}-builds-${{ github.sha }}
        path: ./builds

    - name: Create Release
      uses: ncipollo/release-action@v1.14.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        generateReleaseNotes: true
        tag: ${{ github.ref_name }}
        artifacts: ./builds/*
        name: "${{ env.GAME_NAME }} ${{ github.ref_name }}"
        body: |
          ## ${{ env.GAME_NAME }} Release ${{ github.ref_name }}

          üéÆ **Godot Quickstart Game** - Built automatically from GitHub Actions using Godot ${{ env.GODOT_EXPORT_VERSION }}

          ### üì• Downloads
          Download the appropriate build for your platform from the assets below:
          - **Windows**: `.exe` file
          - **Linux**: `.x86_64` file
          - **Web**: `.zip` file (extract and run locally or host on web server)

          ### üîÑ Changes
          See the auto-generated release notes below for detailed changes.

  # Deploy job - only runs on version tags after release
  deploy_game:
    # Only run this job if it's a version tag push
    if: startsWith(github.ref, 'refs/tags/v')
    needs: release_game # Wait for release to complete
    runs-on: ubuntu-latest
    name: "üöÄ Deploy to itch.io"
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.GAME_NAME }}-builds-${{ github.sha }}
        path: ./builds

    - name: Setup Butler (itch.io CLI)
      uses: jdno/setup-butler@v1

    - name: Deploy Web Build to itch.io
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
      run: |
        echo "üöÄ Deploying to itch.io..."
        
        # List all build artifacts for debugging
        echo "üìã Available build files:"
        ls -la ./builds/
        
        # Look for web build in multiple ways
        WEB_BUILD=""
        
        # Method 1: Look for files with 'web' in name (case insensitive)
        WEB_BUILD=$(find ./builds -iname "*web*" -type f | head -1)
        
        # Method 2: Look for index.html (common web export file)
        if [ -z "$WEB_BUILD" ]; then
          WEB_BUILD=$(find ./builds -name "index.html" -type f | head -1)
        fi
        
        # Method 3: Look for .zip files that might contain web build
        if [ -z "$WEB_BUILD" ]; then
          WEB_BUILD=$(find ./builds -name "*.zip" -type f | grep -i web | head -1)
        fi
        
        # Method 4: Look for any .zip file as fallback
        if [ -z "$WEB_BUILD" ]; then
          WEB_BUILD=$(find ./builds -name "*.zip" -type f | head -1)
        fi

        if [ -z "$WEB_BUILD" ]; then
          echo "‚ùå Web build not found in artifacts"
          echo "Available files:"
          find ./builds -type f
          exit 1
        fi

        echo "üì¶ Found web build: $WEB_BUILD"

        # Extract web build if it's a zip
        if [[ "$WEB_BUILD" == *.zip ]]; then
          echo "üì¶ Extracting web build from zip..."
          mkdir -p ./web_build
          unzip "$WEB_BUILD" -d ./web_build
          
          # Find the actual web directory inside the extracted files
          if [ -d "./web_build/web" ]; then
            WEB_DIR="./web_build/web"
          elif [ -f "./web_build/index.html" ]; then
            WEB_DIR="./web_build"
          else
            # Look for any directory containing index.html
            WEB_DIR=$(find ./web_build -name "index.html" -type f -exec dirname {} \; | head -1)
            if [ -z "$WEB_DIR" ]; then
              WEB_DIR="./web_build"
            fi
          fi
        elif [ -f "$WEB_BUILD" ] && [[ "$WEB_BUILD" == *"index.html" ]]; then
          # If we found index.html directly, use its directory
          WEB_DIR=$(dirname "$WEB_BUILD")
        else
          # Use the builds directory as fallback
          WEB_DIR="./builds"
        fi
        
        echo "üéØ Using web directory: $WEB_DIR"
        echo "üìÇ Web directory contents:"
        ls -la "$WEB_DIR"

        # Deploy to itch.io (replace 'your-username/your-game' with actual itch.io project)
        # Format: butler push <build-directory> <user>/<game>:<channel>
        butler push "$WEB_DIR" ${{ secrets.ITCH_USERNAME }}/${{ secrets.ITCH_GAME_NAME }}:web --userversion ${{ github.ref_name }}

        echo "‚úÖ Successfully deployed to itch.io!"
        echo "üåê Game should be available at: https://${{ secrets.ITCH_USERNAME }}.itch.io/${{ secrets.ITCH_GAME_NAME }}"

